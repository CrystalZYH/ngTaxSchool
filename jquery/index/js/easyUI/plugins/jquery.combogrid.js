(function(F){function A(I){var K=F.data(I,"combogrid");var M=K.options;var G=K.grid;F(I).addClass("combogrid-f").combo(M);var H=F(I).combo("panel");if(!G){G=F("<table></table>").appendTo(H);K.grid=G}G.datagrid(F.extend({},M,{border:false,fit:true,singleSelect:(!M.multiple),onLoadSuccess:function(O){var P=F(I).combo("getValues");var N=M.onSelect;M.onSelect=function(){};E(I,P,K.remainText);M.onSelect=N;M.onLoadSuccess.apply(I,arguments)},onClickRow:J,onSelect:function(N,O){L();M.onSelect.call(this,N,O)},onUnselect:function(O,N){L();M.onUnselect.call(this,O,N)},onSelectAll:function(N){L();M.onSelectAll.call(this,N)},onUnselectAll:function(N){if(M.multiple){L()}M.onUnselectAll.call(this,N)}}));function J(N,O){K.remainText=false;L();if(!M.multiple){F(I).combo("hidePanel")}M.onClickRow.call(this,N,O)}function L(){var P=G.datagrid("getSelections");var N=[],O=[];for(var Q=0;Q<P.length;Q++){N.push(P[Q][M.idField]);O.push(P[Q][M.textField])}if(!M.multiple){F(I).combo("setValues",(N.length?N:[""]))}else{F(I).combo("setValues",N)}if(!K.remainText){F(I).combo("setText",O.join(M.separator))}}}function B(J,H){var I=F.data(J,"combogrid");var L=I.options;var K=I.grid;var G=K.datagrid("getRows").length;if(!G){return}var M=L.finder.getTr(K[0],null,"highlight");if(!M.length){M=L.finder.getTr(K[0],null,"selected")}var N;if(!M.length){N=(H=="next"?0:G-1)}else{var N=parseInt(M.attr("datagrid-row-index"));N+=(H=="next"?1:-1);if(N<0){N=G-1}if(N>=G){N=0}}K.datagrid("highlightRow",N);if(L.selectOnNavigation){I.remainText=false;K.datagrid("selectRow",N)}}function E(K,J,G){var T=F.data(K,"combogrid");var I=T.options;var Q=T.grid;var P=Q.datagrid("getRows");var L=[];var S=F(K).combo("getValues");var R=F(K).combo("options");var O=R.onChange;R.onChange=function(){};Q.datagrid("clearSelections");for(var M=0;M<J.length;M++){var N=Q.datagrid("getRowIndex",J[M]);if(N>=0){Q.datagrid("selectRow",N);L.push(P[N][I.textField])}else{L.push(J[M])}}F(K).combo("setValues",S);R.onChange=O;F(K).combo("setValues",J);if(!G){var H=L.join(I.separator);if(F(K).combo("getText")!=H){F(K).combo("setText",H)}}}function C(I,K){var G=F.data(I,"combogrid");var H=G.options;var L=G.grid;G.remainText=true;if(H.multiple&&!K){E(I,[],true)}else{E(I,[K],true)}if(H.mode=="remote"){L.datagrid("clearSelections");L.datagrid("load",F.extend({},H.queryParams,{q:K}))}else{if(!K){return}var M=L.datagrid("getRows");for(var J=0;J<M.length;J++){if(H.filter.call(I,K,M[J])){L.datagrid("clearSelections");L.datagrid("selectRow",J);return}}}}function D(L){var K=F.data(L,"combogrid");var G=K.options;var J=K.grid;var H=G.finder.getTr(J[0],null,"highlight");if(!H.length){H=G.finder.getTr(J[0],null,"selected")}if(!H.length){return}K.remainText=false;var I=parseInt(H.attr("datagrid-row-index"));if(G.multiple){if(H.hasClass("datagrid-row-selected")){J.datagrid("unselectRow",I)}else{J.datagrid("selectRow",I)}}else{J.datagrid("selectRow",I);F(L).combogrid("hidePanel")}}F.fn.combogrid=function(I,H){if(typeof I=="string"){var G=F.fn.combogrid.methods[I];if(G){return G(this,H)}else{return this.combo(I,H)}}I=I||{};return this.each(function(){var J=F.data(this,"combogrid");if(J){F.extend(J.options,I)}else{J=F.data(this,"combogrid",{options:F.extend({},F.fn.combogrid.defaults,F.fn.combogrid.parseOptions(this),I)})}A(this)})};F.fn.combogrid.methods={options:function(G){var H=G.combo("options");return F.extend(F.data(G[0],"combogrid").options,{originalValue:H.originalValue,disabled:H.disabled,readonly:H.readonly})},grid:function(G){return F.data(G[0],"combogrid").grid},setValues:function(G,H){return G.each(function(){E(this,H)})},setValue:function(G,H){return G.each(function(){E(this,[H])})},clear:function(G){return G.each(function(){F(this).combogrid("grid").datagrid("clearSelections");F(this).combo("clear")})},reset:function(G){return G.each(function(){var H=F(this).combogrid("options");if(H.multiple){F(this).combogrid("setValues",H.originalValue)}else{F(this).combogrid("setValue",H.originalValue)}})}};F.fn.combogrid.parseOptions=function(G){var H=F(G);return F.extend({},F.fn.combo.parseOptions(G),F.fn.datagrid.parseOptions(G),F.parser.parseOptions(G,["idField","textField","mode"]))};F.fn.combogrid.defaults=F.extend({},F.fn.combo.defaults,F.fn.datagrid.defaults,{loadMsg:null,idField:null,textField:null,mode:"local",keyHandler:{up:function(G){B(this,"prev");G.preventDefault()},down:function(G){B(this,"next");G.preventDefault()},left:function(G){},right:function(G){},enter:function(G){D(this)},query:function(H,G){C(this,H)}},filter:function(G,H){var I=F(this).combogrid("options");return H[I.textField].indexOf(G)==0}})})(jQuery);